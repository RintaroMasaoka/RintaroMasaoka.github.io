---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ContentCard from '../../components/ContentCard.astro';
import { localize, type Lang } from '../../i18n/utils';
import { getPageData, getPageTypes } from '../../utils/data';

export function getStaticPaths() {
  const types = getPageTypes();
  return types.flatMap((type) => [
    { params: { lang: undefined, type } },
    { params: { lang: 'ja', type } },
  ]);
}

const lang: Lang = (Astro.params.lang as Lang) || 'en';
const type = Astro.params.type as string;
const data = await getPageData(type);
const pageData = data.page;

// カテゴリでグループ化
const grouped = data.categories.map((cat: any) => ({
  ...cat,
  label: localize(cat.label, lang),
  items: data.items.filter((item: any) => item.category === cat.id),
})).filter((cat: any) => cat.items.length > 0);

---

<BaseLayout title={pageData.title[lang]} lang={lang}>
  <div class="mb-8">
    <h1 class="font-serif text-4xl font-bold text-primary-900 dark:text-primary-50 mb-2">{pageData.title[lang]}</h1>
    <p class="text-primary-500 dark:text-primary-400">{pageData.description[lang]}</p>
  </div>

  <nav class="mb-8 py-3 -mx-6 px-6 border-b border-primary-100 dark:border-primary-700">
    <ul class="flex flex-wrap gap-2">
      {grouped.map((cat: any) => (
        <li>
          <a
            href={`#${cat.id}`}
            class="inline-block px-4 py-1.5 text-sm font-medium text-primary-600 dark:text-primary-300 bg-white dark:bg-primary-800 border border-primary-200 dark:border-primary-600 rounded-full hover:border-accent dark:hover:border-accent-light hover:text-accent dark:hover:text-accent-light transition-colors"
          >
            {cat.label}
            <span class="ml-1 text-xs text-primary-400 dark:text-primary-500">({cat.items.length})</span>
          </a>
        </li>
      ))}
    </ul>
  </nav>

  <div class="space-y-12">
    {grouped.map((cat: any) => (
      <section id={cat.id}>
        <h2 class="font-serif text-2xl font-semibold text-primary-900 dark:text-primary-50 mb-6 flex items-center gap-3">
          <span class="w-6 h-1 bg-accent rounded-full"></span>
          {cat.label}
        </h2>
        <div class="grid gap-4">
          {cat.items.map((item: any) => (
            <ContentCard
              title={localize(item.title, lang)}
              year={item.year}
              authors={item.authors ? localize(item.authors, lang) : undefined}
              venue={item.venue ? localize(item.venue, lang) : undefined}
              links={item.links}
              abstract={item.abstract ? localize(item.abstract, lang) : undefined}
              description={item.description ? localize(item.description, lang) : undefined}
              filename={item.filename}
              url={item.url}
              icon={item.icon || cat.icon}
              tags={item.tags ? localize(item.tags, lang) : undefined}
            />
          ))}
        </div>
      </section>
    ))}
  </div>
</BaseLayout>
